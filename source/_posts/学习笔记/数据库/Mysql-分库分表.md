---
title: mysql之分库分表
date: 2019-11-20
categories:
    - 学习
tags:
    - mysql
---

### 为什么要分库分表

当流量不大的时候，单机数据库就够了。后面因为业务的发展请求越来越多，但是我们发现大多数都是读请求，于是我们想到了将数据库的
**写操作**和**读操作**进行分离，使用多个从库（Slaver）副本负责读，使用主库（Master）负责写，主库的数据同步给从库保持数据的一致，从
库可以水平拓展，所以更多的读请求也不成问题

但是当用户量级上来后，写请求越来越多，该怎么办？加一个Master是不能解决问题的， 因为数据要保持一致性，写操作需要2个master
之间同步，相当于是重复了，而且更加复杂。这时就需要用到**分库分表**，对写操作进行切分

<!-- more -->

### 分库分表

#### 垂直切分

##### 垂直分表

* 概念：以字段为依据，按照字段的活跃性，将表中字段拆分到不同的表（主表和拓展表）中
* 场景：系统并发量并没有上来，表的记录并不多，但是字段多，并且热点数据和非热点数据在一起，单行数据所需的存储空间较大。
以至于数据库缓存的数据行减少，查询时会去读磁盘数据产生大量的随机读IO，产生IO瓶颈

![垂直分表](/images/数据库/垂直分表.png)

##### 垂直分库

* 概念：以表为依据，按照业务归属不同，将不同表拆分到不同的库中
* 场景：系统并发量上来了，并且可以抽象出单独的业务模块

![垂直分库](/images/数据库/垂直分库.png)

##### 垂直切分优点、缺点

* 优点
  * 解决业务系统层面的耦合，业务清晰
  * 与微服务的治理类似，也能对不同业务的数据进行分级管理，维护，监控，扩展等
  * 高并发场景下，垂直切分一定程度的提升IO，数据库连接数，单机硬件资源的瓶颈
* 缺点
  * 部分表无法join，只能通过接口聚合方式解决，提升了开发的复杂度
  * 分布式事务处理复杂
  * 依然存在单表数据量过大的问题

#### 水平切分

##### 水平分表

* 概念：以字段为依据，按照一定的策略（hash、range等），将一个**表**中的数据拆分到多个**表**中
* 场景：系统并发量并没有上来，只是单表的数据量太多，影响了SQL效率，加重了CPU负担，以至于成为瓶颈

![水平分表](/images/数据库/水平分表.png)

##### 水平分库

* 概念：以字段为依据，按照一定的策略（hash、range等），将一个**库**中的数据拆分到多个**库**中
* 场景：系统并发量上来了，分表难以根本上解决问题，并且还没有明显的业务归属来垂直分库

![水平分库](/images/数据库/水平分库.png)

##### 水平切分优点、缺点

* 优点
  * 不存在单库数据量过大、高并发的性能瓶颈，提升系统稳定性和负载能力
  * 应用端改造较小，不需要拆分业务模块  
* 缺点
  * 跨分片的事务一致性难以保证
  * 跨库的join关联查询性能较差
  * 数据多次扩展维度和维护量极大

##### 路由规则

* 范围路由（range）
  * 概念：选取有序的数据列作为路由条件，不同分段分散到不同的数据库表中
  * 优点：可以随着数据的增加平滑的扩充新表
  * 缺点：可能存在数据库分布不均匀
* hash算法
  * 概念：选择某列（或几个列的组合）的值进行hash运算，然后根据运算结果分散到不同的数据库表中
  * 优点：表数据分布比较均匀
  * 缺点：初始表数据量不好选取，扩充新的表数据需要重新分布
* 路由配置
  * 使用独立的表（或者配置文件等）记录路由配置信息
  * 优点：使用起来简单灵活，扩充表时只需要迁移指定的数据，然后修改路由表
  * 缺点：必须多查询一次，影响整体性能。**路由表本事太多影响系统整体系统**

### 分库分表组件&中间件

简单易用的组件：

* 当当sharding-jdbc
* 蘑菇街TSharding

强悍重量级的中间件：

* TDDL Smart Client的方式（淘宝）
* Atlas(Qihoo 360)
* alibaba.cobar(是阿里巴巴（B2B）部门开发)
* MyCAT（基于阿里开源的Cobar产品而研发）
* Oceanus(58同城数据库中间件)
* OneProxy(支付宝首席架构师楼方鑫开发)
* vitess（谷歌开发的数据库中间件）

### 分库分表步骤

1. 根据容量（当前容量和增长量）评估分库或分表个数
2. 选key（均匀），确定分表规则（hash或range等）
3. 执行（一般选择双写），尽量减少数据的移动

### 分库分表常见问题

#### 非分区key条件组合查询，数据报表统计

一般大型的系统都会有专门的后台管理系统，而管理系统的查询查询都是用非分区key组合条件查询，并且经常需要做报表来分析数据，这些需求对于分库分表的数据来说实现起来很复杂。此时我们就需要同步数据到es、Hbase等NoSQL数据库中，管理后台再对这部分数据操作即可
![数据同步](/images/数据库/数据同步.png)

#### 扩容问题

##### 水平扩容表

![水平扩容表](/images/数据库/水平扩容表.png)

* 应用配置之双写、重新部署
* 将老库中的旧数据复制到新库中
* 以老库为准校对新库中的老数据
* 应用去掉双写，重新部署

##### 水平扩容库

![水平扩容库](/images/数据库/水平扩容库.png)

1. 增加两个数据库连接，指向主库
2. 修改数据库配置文件，由2个数据源变成4个
3. 备库升级，并和第一步添加的数据连接关联
4. 解除旧的主备同步，添加新的主备同步
5. 删除冗余的数据

### 总结

* 分库分表，首先得知道瓶颈在哪里，然后才能合理地拆分（分库还是分表？水平还是垂直？分几个？）。且不可为了分库分表而拆分
  * IO瓶颈
    * 磁盘读IO瓶颈，热点数据太多，数据库缓存放不下，每次查询时会产生大量的IO，降低查询速度 -> **分库和垂直分表**
    * 网络IO瓶颈，请求的数据太多，网络带宽不够 -> **分库**
  * CPU瓶颈
    * SQL问题，如SQL中包含join，group by，order by，非索引字段条件查询等，增加CPU运算的操作 -> **SQL优化**，建立合适的索引，在业务Service层进行业务计算
    * 单表数据量太大，查询时扫描的行太多，SQL效率低，CPU率先出现瓶颈 -> **水平分表**
* 选key很重要，既要考虑到拆分均匀，也要考虑到非partition key的查询
* 只要能满足需求，拆分规则越简单越好
  